<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Save It!">
    <meta name="theme-color" content="#2e7d32">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://*.supabase.co; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co https://*.supabase.in; img-src 'self' data: https:; font-src 'self' data:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Save It!</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e9 100%);
            min-height: 100vh;
            padding: 1rem;
            padding-bottom: 80px;
        }

        #app {
            max-width: 600px;
            margin: 0 auto;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2e7d32;
        }

        /* Onboarding Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e9 100%);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .onboarding-container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .onboarding-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #2e7d32;
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: #2e7d32;
        }

        .progress-line {
            width: 60px;
            height: 2px;
            background: #e0e0e0;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
        }

        .progress-line.active {
            background: #2e7d32;
        }

        .onboarding-step {
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .onboarding-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .onboarding-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 0.75rem;
        }

        .onboarding-subtitle {
            font-size: 1.125rem;
            color: #666;
            margin-bottom: 2.5rem;
            line-height: 1.6;
        }

        .onboarding-benefits {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            text-align: left;
        }

        .benefit-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .benefit-item:hover {
            background: #f0f9f4;
            transform: translateX(5px);
        }

        .benefit-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .benefit-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .benefit-text {
            font-size: 0.875rem;
            color: #666;
            line-height: 1.5;
        }

        .onboarding-input-container {
            margin-bottom: 2rem;
        }

        .onboarding-input-container label {
            display: block;
            text-align: left;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .onboarding-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            font-family: inherit;
        }

        .onboarding-input:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .input-hint {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: #666;
            text-align: left;
        }

        .onboarding-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .onboarding-actions button {
            flex: 1;
            max-width: 200px;
        }

        .stat-callout {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            color: #e65100;
            margin-bottom: 0.5rem;
        }

        .stat-text {
            font-size: 1.125rem;
            color: #e65100;
            line-height: 1.6;
        }

        .stat-text strong {
            font-weight: 700;
        }

        .onboarding-message {
            font-size: 1rem;
            color: #666;
            line-height: 1.8;
            margin-bottom: 2rem;
            text-align: left;
        }

        .onboarding-tip {
            background: #e8f5e9;
            padding: 1.5rem;
            border-radius: 12px;
            font-size: 0.9375rem;
            color: #1b5e20;
            line-height: 1.6;
            margin-bottom: 2.5rem;
            text-align: left;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        @media (max-width: 640px) {
            .onboarding-overlay {
                padding: 1rem;
            }

            .onboarding-container {
                padding: 2rem 1.5rem;
            }

            .onboarding-title {
                font-size: 1.5rem;
            }

            .onboarding-subtitle {
                font-size: 1rem;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .onboarding-actions {
                flex-direction: column;
            }

            .onboarding-actions button {
                max-width: none;
            }
        }

        /* User Avatar */
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.9);
        }

        .user-avatar:hover {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .user-avatar:active {
            transform: scale(1.02);
        }

        .user-avatar-large {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.95);
        }

        /* User Menu Dropdown */
        .user-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .user-menu-panel {
            position: fixed;
            top: 5rem;
            right: 1rem;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            animation: slideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .user-menu-header {
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e9 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .user-menu-email {
            font-size: 0.875rem;
            color: #666;
            text-align: center;
            word-break: break-word;
            font-weight: 500;
        }

        .user-menu-divider {
            height: 1px;
            background: #e0e0e0;
        }

        .user-menu-item {
            width: 100%;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9375rem;
            font-weight: 500;
            color: #333;
            text-align: left;
            position: relative;
        }

        .user-menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #2e7d32;
            transform: scaleY(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-menu-item:hover {
            background: #f9fafb;
            padding-left: 1.75rem;
        }

        .user-menu-item:hover::before {
            transform: scaleY(1);
        }

        .user-menu-item:active {
            background: #f0f0f0;
        }

        .user-menu-icon {
            font-size: 1.375rem;
            line-height: 1;
        }

        .header-right {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        .period-info {
            font-size: 0.75rem;
            color: #999;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .welcome-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 0.5rem;
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-tagline {
            font-size: 1.125rem;
            color: #666;
            margin-bottom: 2.5rem;
            font-weight: 500;
        }

        .welcome-text {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .welcome-features {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .feature-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: #f0f9f4;
            border-radius: 50px;
            font-size: 0.9rem;
            color: #2e7d32;
            font-weight: 500;
        }

        .feature-icon {
            font-size: 1.25rem;
        }

        .remaining-amount {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .remaining-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remaining-value {
            font-size: 3rem;
            font-weight: 700;
            color: #2e7d32;
            transition: color 0.3s ease;
        }

        .remaining-value.warning {
            color: #f57c00;
        }

        .remaining-value.danger {
            color: #d32f2f;
        }

        .budget-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .form-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
            font-size: 0.875rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        select {
            cursor: pointer;
            background-color: white;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: #2e7d32;
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1b5e20;
        }

        .btn-primary:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #2e7d32;
            border: 2px solid #2e7d32;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #f0f9f4;
        }

        .btn-danger {
            background: transparent;
            color: #d32f2f;
            padding: 0.5rem;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-danger:hover {
            background: #ffebee;
        }

        .expenses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .expenses-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #333;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-item:hover {
            background-color: #f9f9f9;
        }

        .expense-info {
            flex: 1;
        }

        .expense-note {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .expense-time {
            font-size: 0.75rem;
            color: #999;
        }

        .expense-amount {
            font-weight: 600;
            color: #d32f2f;
            margin-right: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 1rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .modal-footer button {
            width: auto;
        }

        .history-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table thead {
            background: #f5f5f5;
        }

        .history-table th {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .history-table th:not(:first-child) {
            text-align: right;
        }

        .history-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-table tbody tr:hover {
            background: #f9f9f9;
        }

        .history-table td {
            padding: 1rem 0.75rem;
            font-size: 0.875rem;
        }

        .history-table td:not(:first-child) {
            text-align: right;
            font-weight: 600;
        }

        .period-week {
            font-weight: 500;
            color: #333;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s;
            font-size: 0.75rem;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .expenses-detail {
            background: #fafafa;
        }

        .expenses-detail td {
            padding: 0 !important;
        }

        .expenses-list {
            padding: 1rem 0.75rem;
            border-top: 1px solid #e0e0e0;
        }

        .expense-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: white;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .expense-detail-item:last-child {
            margin-bottom: 0;
        }

        .no-expenses {
            padding: 1rem;
            text-align: center;
            color: #999;
            font-size: 0.875rem;
        }

        /* Daily Tracker */
        .daily-tracker-card {
            background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e9 100%);
            border: 2px solid #c8e6c9;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-cell {
            aspect-ratio: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            padding: 0.5rem;
        }

        .day-cell.today {
            border-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .day-cell.complete {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-color: #2e7d32;
        }

        .day-name {
            font-size: 0.65rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.125rem;
        }

        .day-cell.complete .day-name {
            color: #1b5e20;
        }

        .day-number {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
        }

        .day-cell.complete .day-number {
            color: #1b5e20;
        }

        .day-check {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            font-size: 0.875rem;
            color: #2e7d32;
            font-weight: 700;
        }

        /* Historical Metrics */
        .metric-box {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2e7d32;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #333;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #2e7d32;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: #f5f5f5;
        }

        .nav-tab.active {
            color: #2e7d32;
        }

        .nav-tab-icon {
            font-size: 1.5rem;
            line-height: 1;
        }

        .nav-tab.active .nav-tab-icon {
            transform: scale(1.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 640px) {
            .app-header {
                gap: 0.5rem;
            }

            .header-right {
                gap: 0.5rem;
            }

            .period-info {
                font-size: 0.75rem;
            }

            .user-menu-panel {
                left: 0.5rem;
                right: 0.5rem;
                width: auto;
                top: 4rem;
            }

            .remaining-value {
                font-size: 2.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .budget-stats {
                gap: 0.75rem;
            }

            .history-table th:nth-child(2),
            .history-table td:nth-child(2) {
                display: none;
            }

            .history-table th,
            .history-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }

            .expand-icon {
                margin-right: 0.25rem;
            }

            .days-grid {
                gap: 0.375rem;
            }

            .day-cell {
                padding: 0.375rem;
            }

            .day-name {
                font-size: 0.6rem;
            }

            .day-number {
                font-size: 0.875rem;
            }

            .day-check {
                font-size: 0.75rem;
            }

            .metric-value {
                font-size: 1.25rem;
            }

            /* Better touch targets for mobile */
            button, .btn-primary, .btn-secondary, .btn-danger {
                min-height: 44px;
                font-size: 1rem;
            }

            input[type="number"], input[type="text"], textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px;
            }

            .modal-content {
                max-width: 95% !important;
                margin: 1rem;
            }

            .card {
                padding: 1rem;
            }

            /* Improve expense list on mobile */
            .expense-item {
                padding: 0.75rem;
            }

            .expense-note {
                font-size: 0.9rem;
            }

            /* Better spacing for metrics on mobile */
            .metric-box {
                padding: 1rem;
            }

            /* Improve nav tabs for mobile */
            .nav-tab {
                min-height: 60px;
            }

            /* Better onboarding on mobile */
            .onboarding-step {
                padding: 1.5rem;
            }

            .benefit-item {
                padding: 0.75rem;
            }

            /* Welcome screen mobile */
            .welcome-title {
                font-size: 2rem;
            }

            .welcome-tagline {
                font-size: 1rem;
            }

            .welcome-icon {
                font-size: 4rem;
            }

            .welcome-features {
                gap: 0.75rem;
            }

            .feature-badge {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-header">
            <div v-if="user" class="app-title">Save It!</div>
            <div class="header-right">
                <div v-if="isSyncing" class="period-info">
                    ‚ü≥ Syncing...
                </div>
                <div v-if="syncError" class="period-info" style="color: #d32f2f;">
                    ‚ö† Sync failed
                </div>
                <!-- User Avatar -->
                <div v-if="user" class="user-avatar" @click="userMenuOpen = !userMenuOpen">
                    {{ userInitials }}
                </div>
            </div>
        </div>

        <!-- User Menu Dropdown -->
        <div v-if="user && userMenuOpen" class="user-menu-overlay" @click="userMenuOpen = false">
            <div class="user-menu-panel" @click.stop>
                <div class="user-menu-header">
                    <div class="user-avatar-large">{{ userInitials }}</div>
                    <div class="user-menu-email">{{ user.email }}</div>
                </div>
                <div class="user-menu-divider"></div>
                <button v-if="currentPeriod" class="user-menu-item" @click="showUpdateBudgetDialog(); userMenuOpen = false;">
                    <span class="user-menu-icon">üí∞</span>
                    <span>Update Budget</span>
                </button>
                <button class="user-menu-item" style="color: #d32f2f;" @click="showClearDataConfirm = true; userMenuOpen = false;">
                    <span class="user-menu-icon">üóëÔ∏è</span>
                    <span>Clear All Data</span>
                </button>
                <button class="user-menu-item" @click="signOut">
                    <span class="user-menu-icon">üö™</span>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="isLoading" class="card welcome-screen">
            <div v-if="!syncError" class="welcome-text">Loading...</div>
            <div v-else>
                <div class="error-icon" style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <div class="welcome-text" style="color: #d32f2f; margin-bottom: 1rem;">{{ syncError }}</div>
                <button class="btn-primary" @click="retrySync" style="margin-bottom: 0.5rem;">Retry</button>
                <button class="btn-secondary" @click="useOfflineMode">Use Offline Mode</button>
            </div>
        </div>

        <!-- Login Screen -->
        <div v-if="!user && !isLoading" class="card welcome-screen">
            <div class="welcome-icon">üí∞</div>
            <div class="welcome-title">Save It!</div>
            <div class="welcome-tagline">Weekly budgets that actually stick</div>

            <div class="welcome-features">
                <div class="feature-badge">
                    <span class="feature-icon">üìä</span>
                    <span>Track weekly</span>
                </div>
                <div class="feature-badge">
                    <span class="feature-icon">üî•</span>
                    <span>Build streaks</span>
                </div>
                <div class="feature-badge">
                    <span class="feature-icon">üîí</span>
                    <span>Secure sync</span>
                </div>
            </div>

            <button class="btn-primary" @click="signInWithGoogle">
                Sign in with Google
            </button>
        </div>

        <!-- Onboarding Flow -->
        <div v-if="showOnboarding" class="onboarding-overlay">
            <div class="onboarding-container">
                <!-- Progress Indicator -->
                <div class="onboarding-progress">
                    <div class="progress-dot" :class="{ active: onboardingStep >= 1, completed: onboardingStep > 1 }"></div>
                    <div class="progress-line" :class="{ active: onboardingStep > 1 }"></div>
                    <div class="progress-dot" :class="{ active: onboardingStep >= 2, completed: onboardingStep > 2 }"></div>
                    <div class="progress-line" :class="{ active: onboardingStep > 2 }"></div>
                    <div class="progress-dot" :class="{ active: onboardingStep >= 3 }"></div>
                </div>

                <!-- Step 1: Welcome -->
                <div v-if="onboardingStep === 1" class="onboarding-step">
                    <div class="onboarding-icon">üéâ</div>
                    <h1 class="onboarding-title">Welcome to Save It!</h1>
                    <p class="onboarding-subtitle">Take control of your finances, one week at a time</p>

                    <div class="onboarding-benefits">
                        <div class="benefit-item">
                            <span class="benefit-icon">üí∞</span>
                            <div>
                                <div class="benefit-title">Weekly Budgets</div>
                                <div class="benefit-text">Set weekly spending goals and track progress in real-time</div>
                            </div>
                        </div>
                        <div class="benefit-item">
                            <span class="benefit-icon">üî•</span>
                            <div>
                                <div class="benefit-title">Build Streaks</div>
                                <div class="benefit-text">Stay motivated with streak tracking and milestone achievements</div>
                            </div>
                        </div>
                        <div class="benefit-item">
                            <span class="benefit-icon">üìä</span>
                            <div>
                                <div class="benefit-title">Smart Insights</div>
                                <div class="benefit-text">View spending patterns and historical data at a glance</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary" @click="onboardingStep = 2">Get Started</button>
                </div>

                <!-- Step 2: Budget Setup -->
                <div v-if="onboardingStep === 2" class="onboarding-step">
                    <div class="onboarding-icon">üíµ</div>
                    <h1 class="onboarding-title">Set Your Weekly Budget</h1>
                    <p class="onboarding-subtitle">How much do you want to spend each week?</p>

                    <div class="onboarding-input-container">
                        <label for="onboarding-budget">Weekly Budget (USD)</label>
                        <input
                            type="number"
                            id="onboarding-budget"
                            v-model.number="onboardingBudget"
                            placeholder="e.g., 200"
                            step="10"
                            min="0.01"
                            class="onboarding-input"
                            @input="preventNegative($event, 'onboardingBudget')"
                            @keyup.enter="completeOnboarding"
                        />
                        <div class="input-hint">üí° Tip: Start with a realistic amount you can track consistently</div>
                    </div>

                    <div class="onboarding-actions">
                        <button class="btn-secondary" @click="skipBudgetSetup">Skip for now</button>
                        <button
                            class="btn-primary"
                            @click="completeOnboarding"
                            :disabled="!onboardingBudget || onboardingBudget <= 0"
                        >
                            Continue
                        </button>
                    </div>
                </div>

                <!-- Step 3: Educational Message -->
                <div v-if="onboardingStep === 3" class="onboarding-step">
                    <div class="onboarding-icon">‚ú®</div>
                    <h1 class="onboarding-title">The Secret to Success</h1>

                    <div class="stat-callout">
                        <div class="stat-number">5x</div>
                        <div class="stat-text">Those who manually log expenses are <strong>5x more likely</strong> to stay within budget</div>
                    </div>

                    <p class="onboarding-message">
                        Daily expense tracking increases your likelihood of hitting financial goals.
                        The simple act of recording each expense makes you more mindful of your spending patterns.
                    </p>

                    <button class="btn-primary btn-large" @click="finishOnboarding">Start Tracking Now</button>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div v-if="user && !currentPeriod && !isLoading" class="card welcome-screen">
            <div class="welcome-icon">üí∞</div>
            <div class="welcome-title">Set Your Weekly Budget</div>
            <div class="welcome-text">
                Set a weekly budget and track your expenses. Your budget rolls over automatically every Monday. If you're starting mid-week, your first week's budget will be adjusted proportionally.
            </div>
            <div style="max-width: 300px; margin: 0 auto;">
                <div class="form-group">
                    <label for="initial-budget">Weekly Budget Amount (USD)</label>
                    <input
                        type="number"
                        id="initial-budget"
                        v-model.number="newBudgetAmount"
                        placeholder="0.00"
                        step="0.01"
                        min="0.01"
                        max="100000"
                        @input="preventNegative($event, 'newBudgetAmount')"
                        @keyup.enter="createNewPeriod"
                    />
                </div>
                <button
                    class="btn-primary"
                    @click="createNewPeriod"
                    :disabled="!newBudgetAmount || newBudgetAmount < 0.01"
                >
                    Start Period
                </button>
            </div>
        </div>

        <!-- Log Tab -->
        <div v-if="user && currentPeriod && !isLoading" class="tab-content" :class="{ active: activeTab === 'dashboard' }">
            <!-- Streak Card -->
            <div v-if="history.length > 0" class="card" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-size: 0.875rem; color: #e65100; font-weight: 600; margin-bottom: 0.25rem;">CURRENT STREAK</div>
                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                            <span style="font-size: 2.5rem; font-weight: 700; color: #e65100;">{{ currentStreak }}</span>
                            <span style="font-size: 1rem; color: #e65100; font-weight: 500;">{{ currentStreak === 1 ? 'week' : 'weeks' }} üî•</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: #e65100; margin-bottom: 0.25rem;">Best</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #e65100;">{{ longestStreak }} üèÜ</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="remaining-amount">
                    <div class="remaining-label">Remaining This Week ({{ formatDateRange(currentPeriod.startISO, currentPeriod.endISO) }})</div>
                    <div class="remaining-value" :class="remainingColorClass">
                        {{ formatCurrency(remainingCents) }}
                    </div>
                </div>
                <div class="budget-stats">
                    <div class="stat-item">
                        <span class="stat-label">Spent</span>
                        <span class="stat-value">{{ formatCurrency(totalSpentCents) }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Budget</span>
                        <span class="stat-value">{{ formatCurrency(currentPeriod.budgetCents) }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Days Left</span>
                        <span class="stat-value">{{ daysLeft }}</span>
                    </div>
                </div>

                <!-- Pro-rated budget notice -->
                <div v-if="isProRatedWeek" style="margin-top: 1rem; padding: 0.75rem; background: #e3f2fd; border-radius: 8px; font-size: 0.875rem; color: #1565c0;">
                    ‚ÑπÔ∏è Your budget is adjusted for the remaining days this week. Starting Monday, you'll get the full ${{ (lastBudgetCents / 100).toFixed(2) }} weekly budget.
                </div>
            </div>

            <!-- Daily Logging Tracker -->
            <div class="card daily-tracker-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="form-title" style="margin-bottom: 0;">Daily Logging</div>
                    <div style="font-size: 0.75rem; color: #666;">{{ weekDays.filter(d => d.isComplete).length }}/7 days</div>
                </div>
                <div class="days-grid">
                    <div
                        v-for="day in weekDays"
                        :key="day.dayKey"
                        class="day-cell"
                        :class="{
                            complete: day.isComplete,
                            today: day.isToday
                        }"
                    >
                        <div class="day-name">{{ day.dayName }}</div>
                        <div class="day-number">{{ day.dayNumber }}</div>
                        <div class="day-check" v-if="day.isComplete">‚úì</div>
                    </div>
                </div>
            </div>

            <!-- Expense Form -->
            <div class="card">
                <div class="form-title">Add Expense</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expense-amount">Amount *</label>
                        <input
                            type="number"
                            id="expense-amount"
                            v-model.number="newExpenseAmount"
                            placeholder="0.00"
                            step="0.01"
                            min="0.01"
                            max="10000"
                            @input="preventNegative($event, 'newExpenseAmount')"
                            @keyup.enter="addExpense"
                        />
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category *</label>
                        <select
                            id="expense-category"
                            v-model="newExpenseNote"
                        >
                            <option value="" disabled>Select a category</option>
                            <option value="Groceries">üõí Groceries</option>
                            <option value="Dining Out">üçΩÔ∏è Dining Out</option>
                            <option value="Transportation">üöó Transportation</option>
                            <option value="Gas/Fuel">‚õΩ Gas/Fuel</option>
                            <option value="Entertainment">üé¨ Entertainment</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Bills/Utilities">üí° Bills/Utilities</option>
                            <option value="Healthcare">üè• Healthcare</option>
                            <option value="Personal Care">üíÖ Personal Care</option>
                            <option value="Coffee/Drinks">‚òï Coffee/Drinks</option>
                            <option value="Subscriptions">üì± Subscriptions</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                </div>
                <button
                    class="btn-primary"
                    @click="addExpense"
                    :disabled="!newExpenseAmount || newExpenseAmount <= 0 || !newExpenseNote"
                >
                    Add Expense
                </button>

                <!-- Done Logging Toggle -->
                <div class="toggle-container">
                    <span class="toggle-label">{{ hasExpensesToday ? 'Done Logging for Today' : 'No Expenses Today' }}</span>
                    <label class="toggle-switch">
                        <input
                            type="checkbox"
                            :checked="weekDays.find(d => d.isToday)?.isComplete"
                            @change="toggleDoneLogging"
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Week Overdue Warning -->
            <div v-if="isPeriodOverdue" class="alert">
                This week ended {{ Math.abs(daysLeft) }} days ago. Refresh the page to start the new week.
            </div>

            <!-- Expenses List -->
            <div v-if="currentPeriod.expenses.length > 0" class="card">
                <div class="expenses-header">
                    <div class="expenses-title">Recent Expenses</div>
                    <span style="font-size: 0.875rem; color: #666;">{{ currentPeriod.expenses.length }} item(s)</span>
                </div>
                <div
                    v-for="expense in sortedExpenses"
                    :key="expense.id"
                    class="expense-item"
                >
                    <div class="expense-info">
                        <div class="expense-note">{{ expense.note || 'No note' }}</div>
                        <div class="expense-time">{{ formatDate(expense.tsISO) }}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="expense-amount">{{ formatCurrency(expense.amountCents) }}</div>
                        <button
                            class="btn-danger"
                            @click="confirmDeleteExpense(expense.id)"
                            title="Delete expense"
                        >
                            ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <!-- Update Budget Modal -->
            <div class="modal" :class="{ active: newPeriodDialogVisible }">
                <div class="modal-content">
                    <div class="modal-header">Update Weekly Budget</div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-period-budget">Weekly Budget Amount (USD)</label>
                            <input
                                type="number"
                                id="new-period-budget"
                                v-model.number="newBudgetAmount"
                                placeholder="0.00"
                                step="0.01"
                                min="0.01"
                                max="100000"
                                @input="preventNegative($event, 'newBudgetAmount')"
                            />
                        </div>

                        <!-- Show pro-rated budget preview -->
                        <div v-if="willBeProRated && newBudgetAmount > 0" style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <div style="font-size: 0.875rem; color: #856404; margin-bottom: 0.5rem;">
                                <strong>This week's budget:</strong> ${{ (calculatedThisWeekBudget / 100).toFixed(2) }}
                            </div>
                            <div style="font-size: 0.75rem; color: #856404;">
                                Since you're joining mid-week, this week's budget is adjusted for the remaining days. Starting Monday, you'll get the full ${{ newBudgetAmount.toFixed(2) }} weekly budget.
                            </div>
                        </div>

                        <div v-else-if="newBudgetAmount > 0" style="margin-top: 1rem; padding: 0.75rem; background: #e8f5e9; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #2e7d32;">
                                ‚úì This week you'll get the full ${{ newBudgetAmount.toFixed(2) }} budget
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" @click="newPeriodDialogVisible = false">Cancel</button>
                        <button
                            class="btn-primary"
                            @click="updateBudget"
                            :disabled="!newBudgetAmount || newBudgetAmount <= 0"
                        >
                            Update
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal" :class="{ active: deleteConfirmExpenseId !== null }">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">Confirm Delete</div>
                <div class="modal-body">
                    <p style="margin: 0; text-align: center;">Are you sure you want to delete this expense?</p>
                    <p style="margin: 0.5rem 0 0; text-align: center; font-size: 0.875rem; color: #666;">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @click="cancelDeleteExpense">Cancel</button>
                    <button
                        class="btn-danger"
                        @click="deleteExpense(deleteConfirmExpenseId)"
                    >
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Clear All Data Confirmation Modal -->
        <div class="modal" :class="{ active: showClearDataConfirm }">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header" style="color: #d32f2f;">‚ö†Ô∏è Clear All Data</div>
                <div class="modal-body">
                    <p style="margin: 0 0 1rem 0; text-align: center; font-weight: 600;">This will permanently delete:</p>
                    <ul style="margin: 0 0 1rem 2rem; text-align: left;">
                        <li>All budget periods</li>
                        <li>All expenses</li>
                        <li>All history and streaks</li>
                        <li>Your onboarding status</li>
                    </ul>
                    <p style="margin: 0; text-align: center; font-size: 0.875rem; color: #d32f2f; font-weight: 600;">This action cannot be undone!</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" @click="showClearDataConfirm = false">Cancel</button>
                    <button
                        class="btn-danger"
                        @click="clearAllData"
                    >
                        Clear Everything
                    </button>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div v-if="user && !isLoading" class="tab-content" :class="{ active: activeTab === 'history' }">
            <!-- Historical Metrics -->
            <div v-if="history.length > 0" class="card" style="margin-bottom: 1rem;">
                <h2 style="margin-bottom: 1rem;">üìà Historical Metrics</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div class="metric-box">
                        <div class="metric-label">Total Weeks</div>
                        <div class="metric-value">{{ history.length }}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-value">{{ successRate }}%</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Avg per Week</div>
                        <div class="metric-value">{{ formatCurrency(avgSpendingPerWeek) }}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Total Saved</div>
                        <div class="metric-value">{{ formatCurrency(totalHistoricalSavings) }}</div>
                    </div>
                </div>
            </div>

            <div v-if="history.length > 0" class="card" style="padding: 0; overflow: hidden;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Budget</th>
                            <th>Spent</th>
                            <th>Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-for="period in history" :key="period.id">
                            <tr @click="togglePeriodExpanded(period.id)">
                                <td>
                                    <span class="expand-icon" :class="{ expanded: expandedPeriods[period.id] }">‚ñ∂</span>
                                    <span class="period-week">{{ formatDateRange(period.startISO, period.endISO) }}</span>
                                </td>
                                <td>{{ formatCurrency(period.budgetCents) }}</td>
                                <td>{{ formatCurrency(period.totalSpentCents) }}</td>
                                <td :style="{ color: (period.budgetCents - period.totalSpentCents) < 0 ? '#d32f2f' : '#2e7d32' }">
                                    {{ formatCurrency(period.budgetCents - period.totalSpentCents) }}
                                </td>
                            </tr>
                            <tr v-if="expandedPeriods[period.id]" class="expenses-detail">
                                <td colspan="4">
                                    <div v-if="period.expenses.length > 0" class="expenses-list">
                                        <div
                                            v-for="expense in period.expenses"
                                            :key="expense.id"
                                            class="expense-detail-item"
                                        >
                                            <div>
                                                <div style="font-weight: 500;">{{ expense.note || 'No note' }}</div>
                                                <div style="font-size: 0.75rem; color: #999;">{{ formatTimestamp(expense.tsISO) }}</div>
                                            </div>
                                            <div style="font-weight: 600; color: #d32f2f;">{{ formatCurrency(expense.amountCents) }}</div>
                                        </div>
                                    </div>
                                    <div v-else class="no-expenses">
                                        No expenses recorded
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div v-else class="card">
                <div class="welcome-text" style="text-align: center;">No history yet. Complete your first week to see it here.</div>
            </div>
        </div>

        <!-- Goals Tab -->
        <div v-if="user && !isLoading" class="tab-content" :class="{ active: activeTab === 'goals' }">
            <!-- Streak Overview Card -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">üéØ Your Progress</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <!-- Current Streak -->
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px;">
                        <div style="font-size: 0.875rem; color: #e65100; font-weight: 600; margin-bottom: 0.5rem;">CURRENT STREAK</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #e65100;">üî• {{ currentStreak }}</div>
                        <div style="font-size: 0.875rem; color: #e65100;">{{ currentStreak === 1 ? 'week' : 'weeks' }}</div>
                    </div>

                    <!-- Longest Streak -->
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px;">
                        <div style="font-size: 0.875rem; color: #1565c0; font-weight: 600; margin-bottom: 0.5rem;">LONGEST STREAK</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #1565c0;">üèÜ {{ longestStreak }}</div>
                        <div style="font-size: 0.875rem; color: #1565c0;">{{ longestStreak === 1 ? 'week' : 'weeks' }}</div>
                    </div>
                </div>

                <!-- Next Milestone Progress -->
                <div v-if="nextMilestone" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600; color: #666;">Next Milestone: {{ nextMilestone.icon }} {{ nextMilestone.name }}</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: #2e7d32;">{{ longestStreak }}/{{ nextMilestone.weeks }} weeks</span>
                    </div>
                    <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #2e7d32 0%, #66bb6a 100%); border-radius: 6px; transition: width 0.3s ease;" :style="{ width: progressToNextMilestone + '%' }"></div>
                    </div>
                </div>

                <!-- All Done Message -->
                <div v-else style="padding: 1.5rem; background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); border-radius: 12px; text-align: center;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: #f57f17; margin-bottom: 0.5rem;">üéâ Congratulations!</div>
                    <div style="font-size: 0.875rem; color: #f57f17;">You've achieved all milestones! Keep going to maintain your legendary status!</div>
                </div>
            </div>

            <!-- Milestones Card -->
            <div class="card">
                <h2 style="margin-bottom: 1rem;">üèÖ Milestones</h2>

                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div
                        v-for="milestone in milestones"
                        :key="milestone.weeks"
                        style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 8px; transition: all 0.2s;"
                        :style="{
                            background: longestStreak >= milestone.weeks ? '#e8f5e9' : '#f5f5f5',
                            opacity: longestStreak >= milestone.weeks ? 1 : 0.6
                        }"
                    >
                        <div style="font-size: 2rem; line-height: 1;">{{ milestone.icon }}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">{{ milestone.name }}</div>
                            <div style="font-size: 0.875rem; color: #666;">{{ milestone.weeks }} {{ milestone.weeks === 1 ? 'week' : 'weeks' }}</div>
                        </div>
                        <div v-if="longestStreak >= milestone.weeks" style="color: #2e7d32; font-size: 1.5rem;">‚úì</div>
                    </div>
                </div>
            </div>

            <!-- No History Message -->
            <div v-if="history.length === 0" class="card" style="text-align: center; padding: 3rem 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                <div style="font-size: 1.125rem; font-weight: 600; color: #333; margin-bottom: 0.5rem;">Start Your Journey</div>
                <div style="font-size: 0.875rem; color: #666;">Complete your first week under budget to start tracking your streak!</div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div v-if="user && !isLoading" class="bottom-nav">
            <button
                class="nav-tab"
                :class="{ active: activeTab === 'dashboard' }"
                @click="activeTab = 'dashboard'"
            >
                <span class="nav-tab-icon">üìä</span>
                <span>Log</span>
            </button>
            <button
                class="nav-tab"
                :class="{ active: activeTab === 'goals' }"
                @click="activeTab = 'goals'"
            >
                <span class="nav-tab-icon">üéØ</span>
                <span>Goals</span>
            </button>
            <button
                class="nav-tab"
                :class="{ active: activeTab === 'history' }"
                @click="activeTab = 'history'"
            >
                <span class="nav-tab-icon">üìú</span>
                <span>History</span>
            </button>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js" crossorigin="anonymous"></script>

    <script type="module">
        const { createApp } = Vue;

        // Supabase configuration from environment variables
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        createApp({
            data() {
                return {
                    currentPeriod: null,
                    history: [],
                    lastBudgetCents: null,
                    newExpenseAmount: null,
                    newExpenseNote: '',
                    newBudgetAmount: null,
                    newPeriodDialogVisible: false,
                    user: null,
                    isLoading: true,
                    isSyncing: false,
                    syncError: null,
                    activeTab: 'dashboard',
                    longestStreak: 0,
                    expandedPeriods: {},
                    userMenuOpen: false,
                    showOnboarding: false,
                    onboardingStep: 1,
                    onboardingBudget: null,
                    deleteConfirmExpenseId: null,
                    showClearDataConfirm: false
                };
            },
            computed: {
                totalSpentCents() {
                    if (!this.currentPeriod) return 0;
                    return this.currentPeriod.expenses.reduce((sum, exp) => sum + exp.amountCents, 0);
                },
                remainingCents() {
                    if (!this.currentPeriod) return 0;
                    return this.currentPeriod.budgetCents - this.totalSpentCents;
                },
                remainingColorClass() {
                    if (!this.currentPeriod) return '';
                    const remaining = this.remainingCents;
                    const budget = this.currentPeriod.budgetCents;

                    if (remaining < 0) return 'danger';
                    if (remaining < budget * 0.2) return 'warning';
                    return '';
                },
                daysLeft() {
                    if (!this.currentPeriod) return 0;
                    const now = new Date();
                    const end = new Date(this.currentPeriod.endISO);
                    const diffMs = end - now;
                    const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                    return diffDays;
                },
                isPeriodOverdue() {
                    if (!this.currentPeriod) return false;
                    return this.daysLeft < 0;
                },
                sortedExpenses() {
                    if (!this.currentPeriod) return [];
                    return [...this.currentPeriod.expenses].sort((a, b) =>
                        new Date(b.tsISO) - new Date(a.tsISO)
                    );
                },
                isProRatedWeek() {
                    if (!this.currentPeriod || !this.lastBudgetCents) return false;
                    return this.currentPeriod.budgetCents < this.lastBudgetCents;
                },
                calculatedThisWeekBudget() {
                    if (!this.newBudgetAmount || !this.currentPeriod) return 0;

                    const weeklyBudgetCents = Math.round(this.newBudgetAmount * 100);
                    const now = new Date();
                    const end = new Date(this.currentPeriod.endISO);
                    const daysInPeriod = Math.ceil((end - now) / (1000 * 60 * 60 * 24));

                    return daysInPeriod < 7
                        ? Math.round(weeklyBudgetCents * (daysInPeriod / 7))
                        : weeklyBudgetCents;
                },
                willBeProRated() {
                    if (!this.newBudgetAmount || !this.currentPeriod) return false;
                    return this.calculatedThisWeekBudget < Math.round(this.newBudgetAmount * 100);
                },
                currentStreak() {
                    if (!this.history.length) return 0;
                    let streak = 0;
                    for (const period of this.history) {
                        const success = period.success ?? ((period.totalSpentCents ?? 0) <= period.budgetCents);
                        if (success) streak++;
                        else break;
                    }
                    return streak;
                },
                milestones() {
                    return [
                        { name: 'First Win', weeks: 1, icon: 'üéâ' },
                        { name: 'Getting Started', weeks: 2, icon: 'üå±' },
                        { name: 'Building Habits', weeks: 3, icon: 'üí™' },
                        { name: 'One Month Strong', weeks: 4, icon: 'üìÖ' },
                        { name: 'Consistent', weeks: 6, icon: '‚≠ê' },
                        { name: 'Impressive', weeks: 8, icon: 'üî•' },
                        { name: 'Unstoppable', weeks: 12, icon: 'üöÄ' },
                        { name: 'Half Year Hero', weeks: 26, icon: 'üëë' },
                        { name: 'Legend', weeks: 52, icon: 'üèÜ' }
                    ];
                },
                achievedMilestones() {
                    return this.milestones.filter(m => this.longestStreak >= m.weeks);
                },
                nextMilestone() {
                    return this.milestones.find(m => this.longestStreak < m.weeks);
                },
                progressToNextMilestone() {
                    if (!this.nextMilestone) return 100;
                    return Math.min(100, (this.longestStreak / this.nextMilestone.weeks) * 100);
                },
                weekDays() {
                    if (!this.currentPeriod) return [];

                    const days = [];
                    const start = new Date(this.currentPeriod.startISO);

                    for (let i = 0; i < 7; i++) {
                        const day = new Date(start);
                        day.setDate(start.getDate() + i);
                        const dayKey = day.toISOString().split('T')[0]; // 'YYYY-MM-DD'

                        // Day is complete only if it's in the daysMarkedDone array
                        const isMarkedDone = this.currentPeriod.daysMarkedDone.includes(dayKey);

                        days.push({
                            date: day,
                            dayKey: dayKey,
                            dayName: day.toLocaleDateString('en-US', { weekday: 'short' }),
                            dayNumber: day.getDate(),
                            isComplete: isMarkedDone,
                            isToday: dayKey === new Date().toISOString().split('T')[0]
                        });
                    }

                    return days;
                },
                hasExpensesToday() {
                    if (!this.currentPeriod) return false;

                    const today = new Date().toISOString().split('T')[0];
                    return this.currentPeriod.expenses.some(exp => {
                        const expDate = new Date(exp.tsISO).toISOString().split('T')[0];
                        return expDate === today;
                    });
                },
                successRate() {
                    if (!this.history.length) return 0;
                    const successfulWeeks = this.history.filter(period => {
                        const success = period.success ?? (period.totalSpentCents <= period.budgetCents);
                        return success;
                    }).length;
                    return Math.round((successfulWeeks / this.history.length) * 100);
                },
                totalHistoricalSpending() {
                    if (!this.history.length) return 0;
                    return this.history.reduce((sum, period) => sum + period.totalSpentCents, 0);
                },
                totalHistoricalSavings() {
                    if (!this.history.length) return 0;
                    return this.history.reduce((sum, period) => {
                        const savings = period.budgetCents - period.totalSpentCents;
                        return sum + savings;
                    }, 0);
                },
                avgSpendingPerWeek() {
                    if (!this.history.length) return 0;
                    return Math.round(this.totalHistoricalSpending / this.history.length);
                },
                userInitials() {
                    if (!this.user) return '?';

                    // Try to get name from Google auth metadata
                    const fullName = this.user.user_metadata?.full_name || this.user.user_metadata?.name;

                    if (fullName) {
                        const nameParts = fullName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            // First and last name
                            return (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                        } else if (nameParts.length === 1) {
                            // Single name, take first 2 chars
                            return nameParts[0].substring(0, 2).toUpperCase();
                        }
                    }

                    // Fallback to email
                    if (this.user.email) {
                        const emailName = this.user.email.split('@')[0];
                        const parts = emailName.split(/[._-]/);
                        if (parts.length >= 2) {
                            return (parts[0][0] + parts[1][0]).toUpperCase();
                        }
                        return emailName.substring(0, 2).toUpperCase();
                    }

                    return '??';
                }
            },
            methods: {
                async signInWithGoogle() {
                    const { error } = await supabaseClient.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.origin
                        }
                    });
                    if (error) {
                        alert('Error signing in: ' + error.message);
                    }
                },

                async retrySync() {
                    this.syncError = null;
                    this.isSyncing = false;
                    await this.checkAuth();
                },

                useOfflineMode() {
                    console.log('Using offline mode...');
                    this.syncError = null;
                    this.isLoading = false;
                    this.isSyncing = false;
                    this.loadData();
                },

                async clearAllData() {
                    try {
                        this.showClearDataConfirm = false;
                        this.isSyncing = true;

                        if (this.user) {
                            console.log('Clearing all cloud data...');

                            // Delete all expenses
                            const { error: expensesError } = await supabaseClient
                                .from('expenses')
                                .delete()
                                .eq('user_id', this.user.id);

                            if (expensesError) {
                                console.error('Error deleting expenses:', expensesError);
                            }

                            // Delete all periods
                            const { error: periodsError } = await supabaseClient
                                .from('periods')
                                .delete()
                                .eq('user_id', this.user.id);

                            if (periodsError) {
                                console.error('Error deleting periods:', periodsError);
                            }

                            // Delete user profile
                            const { error: profileError } = await supabaseClient
                                .from('user_profiles')
                                .delete()
                                .eq('user_id', this.user.id);

                            if (profileError) {
                                console.error('Error deleting profile:', profileError);
                            }
                        }

                        // Clear all localStorage
                        localStorage.removeItem('budget.currentPeriod');
                        localStorage.removeItem('budget.history');
                        localStorage.removeItem('budget.lastBudgetCents');
                        localStorage.removeItem('budget.longestStreak');
                        localStorage.removeItem('onboarding.completed');
                        localStorage.removeItem('budget.migrationTo7Day');

                        // Reset app state
                        this.currentPeriod = null;
                        this.history = [];
                        this.lastBudgetCents = null;
                        this.longestStreak = 0;
                        this.showOnboarding = true;
                        this.onboardingStep = 1;

                        console.log('All data cleared successfully!');
                        alert('All data has been cleared. Starting fresh!');

                    } catch (error) {
                        console.error('Error clearing data:', error);
                        alert('Failed to clear some data. Please try again.');
                    } finally {
                        this.isSyncing = false;
                    }
                },

                async signOut() {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) {
                        alert('Error signing out: ' + error.message);
                    } else {
                        this.user = null;
                        this.currentPeriod = null;
                        this.history = [];

                        // Only clear app-specific localStorage keys
                        localStorage.removeItem('budget.currentPeriod');
                        localStorage.removeItem('budget.history');
                        localStorage.removeItem('budget.lastBudgetCents');
                        localStorage.removeItem('budget.longestStreak');
                        localStorage.removeItem('onboarding.completed');
                    }
                },

                async checkAuth() {
                    try {
                        console.log('Starting checkAuth...');
                        this.isLoading = true;

                        console.log('Getting session...');
                        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                        if (sessionError) {
                            console.error('Session error:', sessionError);
                            throw sessionError;
                        }

                        this.user = session?.user || null;
                        console.log('User:', this.user ? 'Logged in' : 'Not logged in');

                        if (this.user) {
                            console.log('Syncing from cloud...');
                            await this.syncFromCloud();

                            console.log('Checking onboarding status...');
                            await this.checkOnboardingStatus();
                        } else {
                            console.log('Loading from localStorage...');
                            this.loadData();
                        }

                        console.log('Migrating periods...');
                        await this.migrateTo7DayPeriod();

                        console.log('Checking rollover...');
                        await this.checkAndRolloverPeriod();

                        console.log('checkAuth complete!');
                    } catch (error) {
                        console.error('Error during auth check:', error);
                        // If auth fails, try to load from localStorage
                        this.loadData();
                    } finally {
                        console.log('Setting isLoading to false');
                        this.isLoading = false;
                    }
                },

                async syncFromCloud() {
                    // Prevent duplicate syncs
                    if (this.isSyncing) {
                        console.log('syncFromCloud: Already syncing, skipping...');
                        return;
                    }

                    try {
                        console.log('syncFromCloud: Starting sync...');
                        this.isSyncing = true;
                        this.syncError = null;

                        console.log('syncFromCloud: Fetching periods...');

                        // Add timeout to prevent hanging forever (15 seconds)
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Sync timed out. Please check your connection and try again.')), 15000);
                        });

                        const fetchPromise = supabaseClient
                            .from('periods')
                            .select(`
                                *,
                                expenses (*)
                            `)
                            .order('start_date', { ascending: false });

                        const { data: periods, error } = await Promise.race([fetchPromise, timeoutPromise]);

                        if (error) {
                            console.error('syncFromCloud: Error fetching periods:', error);
                            console.error('syncFromCloud: Error details:', JSON.stringify(error, null, 2));
                            throw error;
                        }

                        console.log('syncFromCloud: Periods fetched:', periods?.length || 0);

                        const activePeriods = periods.filter(p => !p.closed);
                        const archivedPeriods = periods.filter(p => p.closed);

                        if (activePeriods.length > 0) {
                            const period = activePeriods[0];
                            this.currentPeriod = {
                                id: period.id,
                                startISO: period.start_date,
                                endISO: period.end_date,
                                budgetCents: period.budget_cents,
                                closed: period.closed,
                                daysMarkedDone: period.days_marked_done || [],
                                expenses: period.expenses.map(e => ({
                                    id: e.id,
                                    tsISO: e.timestamp,
                                    amountCents: e.amount_cents,
                                    note: e.note || ''
                                }))
                            };
                        }

                        this.history = archivedPeriods.map(period => ({
                            id: period.id,
                            startISO: period.start_date,
                            endISO: period.end_date,
                            budgetCents: period.budget_cents,
                            totalSpentCents: period.total_spent_cents,
                            closed: true,
                            success: period.success,
                            expenses: period.expenses.map(e => ({
                                id: e.id,
                                tsISO: e.timestamp,
                                amountCents: e.amount_cents,
                                note: e.note || ''
                            }))
                        }));

                        // Calculate longest streak from history (only closed periods)
                        let maxStreak = 0;
                        let tempStreak = 0;

                        // Iterate from oldest to newest to find longest consecutive streak
                        // Only count closed periods, not the current active period
                        for (let i = this.history.length - 1; i >= 0; i--) {
                            const period = this.history[i];
                            const success = period.success ?? ((period.totalSpentCents ?? 0) <= period.budgetCents);

                            if (success) {
                                tempStreak++;
                                maxStreak = Math.max(maxStreak, tempStreak);
                            } else {
                                tempStreak = 0;
                            }
                        }

                        // longestStreak should only count completed periods
                        // Don't include currentStreak since it may include the active period
                        this.longestStreak = maxStreak;
                        localStorage.setItem('budget.longestStreak', this.longestStreak);

                        console.log('syncFromCloud: Saving data...');
                        this.saveData();
                        console.log('syncFromCloud: Sync complete!');

                    } catch (error) {
                        console.error('syncFromCloud: Sync error:', error);
                        this.syncError = error.message;
                        this.loadData();
                    } finally {
                        console.log('syncFromCloud: Setting isSyncing to false');
                        this.isSyncing = false;
                    }
                },

                loadData() {
                    try {
                        const currentStr = localStorage.getItem('budget.currentPeriod');
                        if (currentStr) {
                            this.currentPeriod = JSON.parse(currentStr);
                        }

                        const historyStr = localStorage.getItem('budget.history');
                        if (historyStr) {
                            this.history = JSON.parse(historyStr);
                        }

                        const lastBudgetStr = localStorage.getItem('budget.lastBudgetCents');
                        if (lastBudgetStr) {
                            this.lastBudgetCents = parseInt(lastBudgetStr);
                            this.newBudgetAmount = this.lastBudgetCents / 100;
                        }

                        // Load longest streak (only counts completed periods)
                        const storedLongestStreak = localStorage.getItem('budget.longestStreak');
                        this.longestStreak = storedLongestStreak ? parseInt(storedLongestStreak) : 0;
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                },
                saveData() {
                    try {
                        if (this.currentPeriod) {
                            localStorage.setItem('budget.currentPeriod', JSON.stringify(this.currentPeriod));
                        } else {
                            localStorage.removeItem('budget.currentPeriod');
                        }

                        localStorage.setItem('budget.history', JSON.stringify(this.history));

                        if (this.lastBudgetCents !== null) {
                            localStorage.setItem('budget.lastBudgetCents', this.lastBudgetCents.toString());
                        }
                    } catch (error) {
                        console.error('Error saving data:', error);
                    }
                },
                async createNewPeriod() {
                    if (!this.newBudgetAmount || this.newBudgetAmount < 0.01) return;

                    const start = this.getWeekStart();
                    const end = this.getWeekEnd(start);
                    const weeklyBudgetCents = Math.round(this.newBudgetAmount * 100);

                    // Calculate days in period for pro-rating
                    const now = new Date();
                    const daysInPeriod = Math.ceil((end - now) / (1000 * 60 * 60 * 24));

                    // Pro-rate budget if partial week (less than 7 days)
                    const budgetCents = daysInPeriod < 7
                        ? Math.round(weeklyBudgetCents * (daysInPeriod / 7))
                        : weeklyBudgetCents;

                    try {
                        if (this.user) {
                            this.isSyncing = true;

                            // Archive current period if exists
                            if (this.currentPeriod) {
                                await supabaseClient
                                    .from('periods')
                                    .update({ closed: true })
                                    .eq('id', this.currentPeriod.id);
                            }

                            // Create new period in cloud
                            const { data: newPeriod, error } = await supabaseClient
                                .from('periods')
                                .insert({
                                    user_id: this.user.id,
                                    start_date: start.toISOString(),
                                    end_date: end.toISOString(),
                                    budget_cents: budgetCents,
                                    days_marked_done: [],
                                    closed: false
                                })
                                .select()
                                .single();

                            if (error) throw error;

                            // Update local state
                            if (this.currentPeriod) {
                                this.history.unshift({
                                    ...this.currentPeriod,
                                    closed: true,
                                    totalSpentCents: this.totalSpentCents
                                });
                            }

                            this.currentPeriod = {
                                id: newPeriod.id,
                                startISO: newPeriod.start_date,
                                endISO: newPeriod.end_date,
                                budgetCents: newPeriod.budget_cents,
                                daysMarkedDone: [],
                                expenses: [],
                                closed: false
                            };

                        } else {
                            // Local-only mode
                            if (this.currentPeriod) {
                                const archivedPeriod = {
                                    ...this.currentPeriod,
                                    closed: true,
                                    totalSpentCents: this.totalSpentCents
                                };
                                this.history.unshift(archivedPeriod);
                            }

                            this.currentPeriod = {
                                id: this.generateId(),
                                startISO: start.toISOString(),
                                endISO: end.toISOString(),
                                budgetCents: budgetCents,
                                daysMarkedDone: [],
                                expenses: [],
                                closed: false
                            };
                        }

                        // Store the full weekly budget for future periods
                        this.lastBudgetCents = weeklyBudgetCents;
                        this.newBudgetAmount = weeklyBudgetCents / 100;
                        this.newPeriodDialogVisible = false;
                        this.saveData();

                    } catch (error) {
                        console.error('Error creating period:', error);
                        alert('Failed to create period. ' + this.sanitizeError(error));
                    } finally {
                        this.isSyncing = false;
                    }
                },
                async addExpense() {
                    if (!this.newExpenseAmount || this.newExpenseAmount < 0.01 || !this.newExpenseNote) return;

                    const amountCents = Math.round(this.newExpenseAmount * 100);
                    const note = this.sanitizeInput(this.newExpenseNote);
                    const timestamp = new Date().toISOString();

                    try {
                        if (this.user) {
                            this.isSyncing = true;

                            // Create expense in cloud
                            const { data: newExpense, error } = await supabaseClient
                                .from('expenses')
                                .insert({
                                    period_id: this.currentPeriod.id,
                                    user_id: this.user.id,
                                    amount_cents: amountCents,
                                    note: note,
                                    timestamp: timestamp
                                })
                                .select()
                                .single();

                            if (error) throw error;

                            // Add to local state
                            this.currentPeriod.expenses.push({
                                id: newExpense.id,
                                tsISO: newExpense.timestamp,
                                amountCents: newExpense.amount_cents,
                                note: newExpense.note || ''
                            });

                        } else {
                            // Local-only mode
                            this.currentPeriod.expenses.push({
                                id: this.generateId(),
                                tsISO: timestamp,
                                amountCents: amountCents,
                                note: note
                            });
                        }

                        // Reset form
                        this.newExpenseAmount = null;
                        this.newExpenseNote = '';
                        this.saveData();

                    } catch (error) {
                        console.error('Error adding expense:', error);
                        alert('Failed to add expense. Please try again.');
                    } finally {
                        this.isSyncing = false;
                    }
                },
                confirmDeleteExpense(expenseId) {
                    this.deleteConfirmExpenseId = expenseId;
                },
                cancelDeleteExpense() {
                    this.deleteConfirmExpenseId = null;
                },
                async deleteExpense(expenseId) {
                    // Close confirmation dialog
                    this.deleteConfirmExpenseId = null;
                    try {
                        if (this.user) {
                            this.isSyncing = true;

                            // Delete from cloud first
                            const { error } = await supabaseClient
                                .from('expenses')
                                .delete()
                                .eq('id', expenseId);

                            if (error) throw error;

                            // Only delete locally if cloud delete succeeded
                            const index = this.currentPeriod.expenses.findIndex(e => e.id === expenseId);
                            if (index !== -1) {
                                this.currentPeriod.expenses.splice(index, 1);
                                this.saveData();
                            }
                        } else {
                            // Local-only mode - safe to delete immediately
                            const index = this.currentPeriod.expenses.findIndex(e => e.id === expenseId);
                            if (index !== -1) {
                                this.currentPeriod.expenses.splice(index, 1);
                                this.saveData();
                            }
                        }

                    } catch (error) {
                        console.error('Error deleting expense:', error);
                        alert('Failed to delete expense. Please try again.');
                    } finally {
                        if (this.user) {
                            this.isSyncing = false;
                        }
                    }
                },
                showUpdateBudgetDialog() {
                    if (this.currentPeriod) {
                        this.newBudgetAmount = this.currentPeriod.budgetCents / 100;
                    }
                    this.newPeriodDialogVisible = true;
                },
                async updateBudget() {
                    if (!this.newBudgetAmount || this.newBudgetAmount < 0.01) return;

                    const budgetCents = Math.round(this.newBudgetAmount * 100);

                    try {
                        if (this.user && this.currentPeriod) {
                            this.isSyncing = true;

                            // Update current period budget
                            const { error } = await supabaseClient
                                .from('periods')
                                .update({ budget_cents: budgetCents })
                                .eq('id', this.currentPeriod.id);

                            if (error) throw error;

                            this.currentPeriod.budgetCents = budgetCents;
                        } else if (this.currentPeriod) {
                            // Local-only mode
                            this.currentPeriod.budgetCents = budgetCents;
                        }

                        this.lastBudgetCents = budgetCents;
                        this.newPeriodDialogVisible = false;
                        this.saveData();

                    } catch (error) {
                        console.error('Error updating budget:', error);
                        alert('Failed to update budget. Please try again.');
                    } finally {
                        if (this.user) {
                            this.isSyncing = false;
                        }
                    }
                },
                sanitizeInput(text) {
                    // Remove HTML tags and potentially dangerous characters
                    if (!text) return '';
                    return text
                        .replace(/<[^>]*>/g, '') // Remove HTML tags
                        .replace(/[<>]/g, '') // Remove remaining < and >
                        .trim();
                },
                preventNegative(event, fieldName) {
                    // Prevent negative numbers in number inputs
                    if (this[fieldName] < 0) {
                        this[fieldName] = 0;
                    }
                },
                sanitizeError(error) {
                    // Sanitize error messages to avoid leaking implementation details
                    console.error('Detailed error:', error);

                    // Return generic error messages for security
                    if (error.message) {
                        // Only show safe, generic parts of error messages
                        if (error.message.includes('network') || error.message.includes('fetch')) {
                            return 'Network error. Please check your connection.';
                        }
                        if (error.message.includes('auth') || error.message.includes('permission')) {
                            return 'Authentication error. Please sign in again.';
                        }
                    }
                    return 'An error occurred. Please try again.';
                },
                formatCurrency(cents) {
                    const dollars = cents / 100;
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(dollars);
                },
                formatDateRange(startISO, endISO) {
                    const start = new Date(startISO);
                    const end = new Date(endISO);

                    // Check if same month and year
                    if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
                        const month = start.toLocaleDateString('en-US', { month: 'short' });
                        return `${month} ${start.getDate()}-${end.getDate()}`;
                    }

                    // Different months or years
                    const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    return `${startStr} - ${endStr}`;
                },
                formatTimestamp(iso) {
                    const date = new Date(iso);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;

                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                },
                formatDate(iso) {
                    const date = new Date(iso);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);

                    const dateKey = date.toISOString().split('T')[0];
                    const todayKey = today.toISOString().split('T')[0];
                    const yesterdayKey = yesterday.toISOString().split('T')[0];

                    if (dateKey === todayKey) {
                        return date.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    } else if (dateKey === yesterdayKey) {
                        return 'Yesterday';
                    } else {
                        return date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                },
                generateId() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2);
                },
                getWeekStart(date = new Date()) {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = day === 0 ? -6 : 1 - day; // Adjust to Monday
                    d.setDate(d.getDate() + diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                },
                getWeekEnd(weekStart) {
                    const end = new Date(weekStart);
                    end.setDate(end.getDate() + 6);
                    end.setHours(23, 59, 59, 999);
                    return end;
                },
                async checkAndRolloverPeriod() {
                    if (!this.currentPeriod) return;

                    const now = new Date();
                    const periodEnd = new Date(this.currentPeriod.endISO);

                    // If period has ended, roll over to new week
                    if (now > periodEnd) {
                        // Use full weekly budget (not pro-rated) for new weeks
                        const budgetCents = this.lastBudgetCents || this.currentPeriod.budgetCents;

                        try {
                            if (this.user) {
                                this.isSyncing = true;

                                // Close expired period
                                const wasSuccessful = this.totalSpentCents <= this.currentPeriod.budgetCents;

                                await supabaseClient
                                    .from('periods')
                                    .update({
                                        closed: true,
                                        total_spent_cents: this.totalSpentCents,
                                        success: wasSuccessful
                                    })
                                    .eq('id', this.currentPeriod.id);

                                // Add to history
                                this.history.unshift({
                                    ...this.currentPeriod,
                                    closed: true,
                                    totalSpentCents: this.totalSpentCents,
                                    success: wasSuccessful
                                });

                                // Update longest streak if current streak is higher
                                if (this.currentStreak > this.longestStreak) {
                                    this.longestStreak = this.currentStreak;
                                    localStorage.setItem('budget.longestStreak', this.longestStreak);
                                }

                                // Create new period for current week
                                const start = this.getWeekStart();
                                const end = this.getWeekEnd(start);

                                const { data: newPeriod, error } = await supabaseClient
                                    .from('periods')
                                    .insert({
                                        user_id: this.user.id,
                                        start_date: start.toISOString(),
                                        end_date: end.toISOString(),
                                        budget_cents: budgetCents,
                                        days_marked_done: [],
                                        closed: false
                                    })
                                    .select()
                                    .single();

                                if (error) throw error;

                                this.currentPeriod = {
                                    id: newPeriod.id,
                                    startISO: newPeriod.start_date,
                                    endISO: newPeriod.end_date,
                                    budgetCents: newPeriod.budget_cents,
                                    daysMarkedDone: [],
                                    expenses: [],
                                    closed: false
                                };
                            } else {
                                // Local-only mode
                                const wasSuccessful = this.totalSpentCents <= this.currentPeriod.budgetCents;

                                this.history.unshift({
                                    ...this.currentPeriod,
                                    closed: true,
                                    totalSpentCents: this.totalSpentCents,
                                    success: wasSuccessful
                                });

                                // Update longest streak if current streak is higher
                                if (this.currentStreak > this.longestStreak) {
                                    this.longestStreak = this.currentStreak;
                                    localStorage.setItem('budget.longestStreak', this.longestStreak);
                                }

                                const start = this.getWeekStart();
                                const end = this.getWeekEnd(start);

                                this.currentPeriod = {
                                    id: this.generateId(),
                                    startISO: start.toISOString(),
                                    endISO: end.toISOString(),
                                    budgetCents: budgetCents,
                                    daysMarkedDone: [],
                                    expenses: [],
                                    closed: false
                                };
                            }

                            this.saveData();
                        } catch (error) {
                            console.error('Error rolling over period:', error);
                        } finally {
                            if (this.user) {
                                this.isSyncing = false;
                            }
                        }
                    }
                },
                async migrateTo7DayPeriod() {
                    // Check if migration has already been completed
                    const migrationCompleted = localStorage.getItem('budget.migrationTo7Day');
                    if (migrationCompleted === 'true') return;

                    // Migrate old 14-day periods to 7-day weekly periods
                    if (!this.currentPeriod) {
                        // No current period, mark migration as complete
                        localStorage.setItem('budget.migrationTo7Day', 'true');
                        return;
                    }

                    const start = new Date(this.currentPeriod.startISO);
                    const end = new Date(this.currentPeriod.endISO);
                    const durationDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                    // If period is longer than 7 days, it's an old 14-day period
                    if (durationDays > 7) {
                        const weekStart = this.getWeekStart(start);
                        const weekEnd = this.getWeekEnd(weekStart);

                        try {
                            if (this.user) {
                                this.isSyncing = true;

                                // Update period end date in cloud
                                const { error } = await supabaseClient
                                    .from('periods')
                                    .update({
                                        start_date: weekStart.toISOString(),
                                        end_date: weekEnd.toISOString()
                                    })
                                    .eq('id', this.currentPeriod.id);

                                if (error) throw error;
                            }

                            // Update local state
                            this.currentPeriod.startISO = weekStart.toISOString();
                            this.currentPeriod.endISO = weekEnd.toISOString();
                            this.saveData();

                            // Mark migration as complete
                            localStorage.setItem('budget.migrationTo7Day', 'true');

                        } catch (error) {
                            console.error('Error migrating period:', error);
                        } finally {
                            if (this.user) {
                                this.isSyncing = false;
                            }
                        }
                    } else {
                        // Period is already 7 days or less, no migration needed
                        localStorage.setItem('budget.migrationTo7Day', 'true');
                    }
                },
                togglePeriodExpanded(periodId) {
                    this.expandedPeriods[periodId] = !this.expandedPeriods[periodId];
                },
                async completeOnboarding() {
                    if (!this.onboardingBudget || this.onboardingBudget < 0.01) return;

                    // Move to educational step
                    this.onboardingStep = 3;
                },
                skipBudgetSetup() {
                    // Skip budget but still show educational message
                    this.onboardingBudget = null;
                    this.onboardingStep = 3;
                },
                async finishOnboarding() {
                    try {
                        // Mark onboarding as completed in localStorage first
                        localStorage.setItem('onboarding.completed', 'true');

                        // Close onboarding
                        this.showOnboarding = false;

                        // Save to Supabase in background (don't block on this)
                        if (this.user) {
                            this.isSyncing = true;

                            // Save onboarding completion status to Supabase
                            supabaseClient
                                .from('user_profiles')
                                .upsert({
                                    user_id: this.user.id,
                                    onboarding_completed: true,
                                    updated_at: new Date().toISOString()
                                })
                                .then(({ error }) => {
                                    if (error) {
                                        console.error('Error saving onboarding status:', error);
                                    }
                                })
                                .finally(() => {
                                    this.isSyncing = false;
                                });
                        }

                        // If budget was set, create first period
                        if (this.onboardingBudget && this.onboardingBudget > 0) {
                            this.newBudgetAmount = this.onboardingBudget;
                            await this.createNewPeriod();
                        }

                    } catch (error) {
                        console.error('Error finishing onboarding:', error);
                        alert('Error completing onboarding. ' + this.sanitizeError(error));
                    }
                },
                async checkOnboardingStatus() {
                    console.log('checkOnboardingStatus: Starting...');

                    // Check if onboarding was completed in localStorage
                    const localCompleted = localStorage.getItem('onboarding.completed');
                    console.log('checkOnboardingStatus: localStorage completed:', localCompleted);

                    if (localCompleted === 'true') {
                        this.showOnboarding = false;
                        console.log('checkOnboardingStatus: Already completed, skipping');
                        return;
                    }

                    // Check if user has existing data (existing user, not new)
                    console.log('checkOnboardingStatus: Checking for existing data...', {
                        currentPeriod: !!this.currentPeriod,
                        historyLength: this.history.length
                    });

                    if (this.currentPeriod || this.history.length > 0) {
                        // User has existing periods, they're not a new user
                        // Mark onboarding as completed so we don't show it
                        localStorage.setItem('onboarding.completed', 'true');
                        this.showOnboarding = false;

                        // Update cloud profile in background
                        if (this.user) {
                            supabaseClient
                                .from('user_profiles')
                                .upsert({
                                    user_id: this.user.id,
                                    onboarding_completed: true,
                                    updated_at: new Date().toISOString()
                                })
                                .then(({ error }) => {
                                    if (error) console.error('Error updating profile:', error);
                                });
                        }
                        return;
                    }

                    // Check cloud status if user is signed in
                    if (this.user) {
                        try {
                            console.log('checkOnboardingStatus: Checking cloud status...');
                            const { data, error } = await supabaseClient
                                .from('user_profiles')
                                .select('onboarding_completed')
                                .eq('user_id', this.user.id)
                                .single();

                            console.log('checkOnboardingStatus: Cloud response:', { data, error });

                            if (!error && data?.onboarding_completed) {
                                localStorage.setItem('onboarding.completed', 'true');
                                this.showOnboarding = false;
                                console.log('checkOnboardingStatus: User has completed onboarding');
                            } else {
                                // First time user - show onboarding
                                this.showOnboarding = true;
                                this.onboardingStep = 1;
                                console.log('checkOnboardingStatus: New user, showing onboarding');
                            }
                        } catch (error) {
                            console.log('checkOnboardingStatus: Error checking cloud, showing onboarding:', error);
                            // If no profile exists, show onboarding (new user)
                            this.showOnboarding = true;
                            this.onboardingStep = 1;
                        }
                    }

                    console.log('checkOnboardingStatus: Complete!');
                },
                async toggleDoneLogging() {
                    if (!this.currentPeriod) return;

                    const today = new Date().toISOString().split('T')[0];
                    const index = this.currentPeriod.daysMarkedDone.indexOf(today);

                    if (index === -1) {
                        // Mark as done
                        this.currentPeriod.daysMarkedDone.push(today);
                    } else {
                        // Unmark
                        this.currentPeriod.daysMarkedDone.splice(index, 1);
                    }

                    // Update in cloud if signed in
                    try {
                        if (this.user) {
                            this.isSyncing = true;

                            const { error } = await supabaseClient
                                .from('periods')
                                .update({ days_marked_done: this.currentPeriod.daysMarkedDone })
                                .eq('id', this.currentPeriod.id);

                            if (error) throw error;
                        }

                        this.saveData();
                    } catch (error) {
                        console.error('Error toggling done logging:', error);
                        alert('Failed to update. Please try again.');
                    } finally {
                        if (this.user) {
                            this.isSyncing = false;
                        }
                    }
                }
            },
            mounted() {
                // Security check: Warn if not using HTTPS in production
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    console.warn('‚ö†Ô∏è WARNING: This app should be served over HTTPS in production for security.');
                }

                this.checkAuth();

                // Listen for auth changes
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    this.user = session?.user || null;
                    if (event === 'SIGNED_IN') {
                        await this.syncFromCloud();
                        await this.checkOnboardingStatus();
                    }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>
